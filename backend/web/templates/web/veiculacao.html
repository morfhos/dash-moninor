{% extends "web/base.html" %}
{% load static %}

{% block content %}
<style>
  .veiculacao-container { padding: 0 0 40px; }

  .veic-filters {
    display: flex;
    align-items: flex-end;
    gap: 12px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }
  .veic-filters .filter-group { display: flex; flex-direction: column; gap: 4px; }
  .veic-filters label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .veic-filters input[type="date"] {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 13px;
    font-family: inherit;
    background: var(--surface);
    color: var(--text-primary);
  }
  .btn-filter {
    padding: 8px 16px;
    background: var(--brand-primary);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: background 0.2s;
  }
  .btn-filter:hover { background: #4c2bc2; }

  .veic-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  .veic-stat-card {
    background: var(--surface);
    border-radius: 14px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .veic-stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .veic-stat-icon.impressions { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #2563eb; }
  .veic-stat-icon.clicks { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #16a34a; }
  .veic-stat-icon.ctr { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #d97706; }
  .veic-stat-icon.cost { background: linear-gradient(135deg, #ede9fe, #ddd6fe); color: #7c3aed; }
  .veic-stat-value {
    font-size: 24px;
    font-weight: 800;
    color: var(--text-primary);
    line-height: 1.1;
  }
  .veic-stat-label {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 500;
    margin-top: 2px;
  }

  .veic-section {
    background: var(--surface);
    border-radius: 16px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    margin-bottom: 24px;
  }
  .veic-section-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-color);
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .campaigns-table {
    width: 100%;
    border-collapse: collapse;
  }
  .campaigns-table th {
    padding: 12px 16px;
    text-align: left;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
    background: var(--surface-2);
    border-bottom: 1px solid var(--border-color);
  }
  .campaigns-table td {
    padding: 12px 16px;
    font-size: 13px;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-color);
  }
  .campaigns-table tr:last-child td { border-bottom: none; }
  .campaigns-table tr:hover { background: var(--surface-2); }
  .campaigns-table .num { text-align: right; font-variant-numeric: tabular-nums; }

  .charts-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }
  @media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }
  .chart-container {
    background: var(--surface);
    border-radius: 16px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
    padding: 24px;
  }
  .chart-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 16px;
  }

  .empty-state {
    padding: 64px 24px;
    text-align: center;
    color: var(--text-secondary);
  }
  .empty-state svg { margin-bottom: 16px; opacity: 0.3; }
  .empty-state h3 {
    font-size: 18px;
    color: var(--text-primary);
    margin-bottom: 8px;
  }
  .empty-state p { font-size: 14px; line-height: 1.6; }
  .empty-state .btn-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 20px;
    padding: 10px 20px;
    background: var(--brand-primary);
    color: white;
    border-radius: 10px;
    text-decoration: none;
    font-size: 14px;
    font-weight: 600;
    transition: background 0.2s;
  }
  .empty-state .btn-link:hover { background: #4c2bc2; }

  .channel-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    background: #dbeafe;
    color: #1e40af;
  }
  .platform-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.3px;
  }
  .platform-badge.google { background: #fef3c7; color: #92400e; }
  .platform-badge.meta { background: #dbeafe; color: #1e40af; }
</style>

<div class="topbar">
  <h1>{{ page_title }}</h1>
</div>

<div class="veiculacao-container">
  {% if not has_accounts and not campaigns_data %}
  <!-- Empty State -->
  <div class="veic-section">
    <div class="empty-state">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M10 13a5 5 0 0 1 0-7l1-1a5 5 0 0 1 7 7l-1 1"></path>
        <path d="M14 11a5 5 0 0 1 0 7l-1 1a5 5 0 0 1-7-7l1-1"></path>
      </svg>
      <h3>Nenhuma conta de anuncios conectada</h3>
      <p>{{ empty_msg }}</p>
      <a href="{% url 'web:integracoes' %}" class="btn-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10 13a5 5 0 0 1 0-7l1-1a5 5 0 0 1 7 7l-1 1"></path>
          <path d="M14 11a5 5 0 0 1 0 7l-1 1a5 5 0 0 1-7-7l1-1"></path>
        </svg>
        Ir para Integracoes
      </a>
    </div>
  </div>
  {% else %}

  <!-- Filters -->
  <form class="veic-filters" method="get">
    <div class="filter-group">
      <label for="dateFrom">Data inicio</label>
      <input type="date" id="dateFrom" name="date_from" value="{{ date_from }}">
    </div>
    <div class="filter-group">
      <label for="dateTo">Data fim</label>
      <input type="date" id="dateTo" name="date_to" value="{{ date_to }}">
    </div>
    <button type="submit" class="btn-filter">Filtrar</button>
  </form>

  <!-- Stats Cards -->
  <div class="veic-stats">
    <div class="veic-stat-card">
      <div class="veic-stat-icon impressions">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
      </div>
      <div>
        <div class="veic-stat-value">{{ total_impressions|floatformat:0 }}</div>
        <div class="veic-stat-label">Impressoes</div>
      </div>
    </div>
    <div class="veic-stat-card">
      <div class="veic-stat-icon clicks">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5"></path>
        </svg>
      </div>
      <div>
        <div class="veic-stat-value">{{ total_clicks|floatformat:0 }}</div>
        <div class="veic-stat-label">Cliques</div>
      </div>
    </div>
    <div class="veic-stat-card">
      <div class="veic-stat-icon ctr">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
        </svg>
      </div>
      <div>
        <div class="veic-stat-value">{{ ctr }}%</div>
        <div class="veic-stat-label">CTR</div>
      </div>
    </div>
    <div class="veic-stat-card">
      <div class="veic-stat-icon cost">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="1" x2="12" y2="23"></line>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
      </div>
      <div>
        <div class="veic-stat-value">R$ {{ total_cost|floatformat:2 }}</div>
        <div class="veic-stat-label">Investimento</div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts-grid">
    <div class="chart-container">
      <div class="chart-title">Metricas Diarias</div>
      <canvas id="dailyChart" height="280"></canvas>
    </div>
    <div class="chart-container">
      <div class="chart-title">Investimento por Campanha</div>
      <canvas id="pieChart" height="280"></canvas>
    </div>
  </div>

  <!-- Campaigns Table -->
  <div class="veic-section">
    <div class="veic-section-header">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2"></rect>
        <path d="M3 9h18"></path>
        <path d="M9 21V9"></path>
      </svg>
      {{ table_title }}
    </div>
    {% if campaigns_data %}
    <table class="campaigns-table">
      <thead>
        <tr>
          <th>Campanha</th>
          {% if show_platform_col %}<th>Plataforma</th>{% endif %}
          <th>Canal</th>
          <th class="num">Impressoes</th>
          <th class="num">Cliques</th>
          <th class="num">CTR</th>
          <th class="num">Custo (R$)</th>
          <th class="num">CPC (R$)</th>
        </tr>
      </thead>
      <tbody>
        {% for c in campaigns_data %}
        <tr>
          <td>
            <strong>{{ c.name }}</strong>
            {% if c.client %}<br><span style="font-size:11px; color:var(--text-secondary);">{{ c.client }}</span>{% endif %}
          </td>
          {% if show_platform_col %}<td><span class="platform-badge {% if c.platform == 'Meta Ads' %}meta{% else %}google{% endif %}">{{ c.platform }}</span></td>{% endif %}
          <td><span class="channel-badge">{{ c.channel }}</span></td>
          <td class="num">{{ c.impressions|floatformat:0 }}</td>
          <td class="num">{{ c.clicks|floatformat:0 }}</td>
          <td class="num">{{ c.ctr }}%</td>
          <td class="num">{{ c.cost|floatformat:2 }}</td>
          <td class="num">{{ c.cpc|floatformat:2 }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty-state" style="padding:40px;">
      <p>Nenhum dado de campanha encontrado para o periodo selecionado.</p>
    </div>
    {% endif %}
  </div>
  {% endif %}
</div>

{% if has_accounts or campaigns_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
(function() {
  var labels = {{ chart_labels_json|safe }};
  var impressions = {{ chart_impressions_json|safe }};
  var clicks = {{ chart_clicks_json|safe }};
  var cost = {{ chart_cost_json|safe }};
  var pieLabels = {{ pie_labels_json|safe }};
  var pieValues = {{ pie_values_json|safe }};

  // Daily Chart
  var dailyCtx = document.getElementById('dailyChart');
  if (dailyCtx && labels.length > 0) {
    new Chart(dailyCtx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Impressoes',
            data: impressions,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59,130,246,0.1)',
            fill: true,
            tension: 0.3,
            yAxisID: 'y',
          },
          {
            label: 'Cliques',
            data: clicks,
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34,197,94,0.1)',
            fill: false,
            tension: 0.3,
            yAxisID: 'y',
          },
          {
            label: 'Custo (R$)',
            data: cost,
            borderColor: '#7c3aed',
            backgroundColor: 'rgba(124,58,237,0.1)',
            fill: false,
            tension: 0.3,
            yAxisID: 'y1',
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { position: 'top', labels: { usePointStyle: true, padding: 16 } }
        },
        scales: {
          y: { position: 'left', beginAtZero: true, title: { display: true, text: 'Impressoes / Cliques' } },
          y1: { position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, title: { display: true, text: 'Custo (R$)' } },
          x: { ticks: { maxTicksLimit: 15 } }
        }
      }
    });
  }

  // Pie Chart
  var pieCtx = document.getElementById('pieChart');
  if (pieCtx && pieLabels.length > 0) {
    var colors = ['#7c3aed','#3b82f6','#22c55e','#f59e0b','#ef4444','#06b6d4','#ec4899','#84cc16','#f97316','#6366f1'];
    new Chart(pieCtx, {
      type: 'doughnut',
      data: {
        labels: pieLabels,
        datasets: [{
          data: pieValues,
          backgroundColor: pieLabels.map(function(_, i) { return colors[i % colors.length]; }),
          borderWidth: 2,
          borderColor: '#fff',
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } }
        }
      }
    });
  }
})();
</script>
{% endif %}
{% endblock %}
